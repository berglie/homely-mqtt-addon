#!/usr/bin/with-contenv bashio
# vim: ft=bash
# shellcheck shell=bash
# ==============================================================================
# Runs Homely MQTT
# ==============================================================================

# Change to the application directory
cd /data/homely-mqtt

# Set environment variables from configuration
export MQTT_BROKER_HOST=$(bashio::config 'mqtt_broker_host')
export MQTT_BROKER_PORT=$(bashio::config 'mqtt_broker_port')
export MQTT_USERNAME=$(bashio::config 'mqtt_username')
export MQTT_PASSWORD=$(bashio::config 'mqtt_password')
export MQTT_CLIENT_ID=$(bashio::config 'mqtt_client_id')
export MQTT_TOPIC_PREFIX=$(bashio::config 'mqtt_topic_prefix')
export LOG_LEVEL=$(bashio::config 'log_level')
export AUTO_DISCOVERY=$(bashio::config 'auto_discovery')
export DISCOVERY_PREFIX=$(bashio::config 'discovery_prefix')
export HOMELY_USER=$(bashio::config 'homely_user')
export HOMELY_PASSWORD=$(bashio::config 'homely_password')
export MQTT_HOST="mqtt://${MQTT_BROKER_HOST}:${MQTT_BROKER_PORT}"

# Start the application
bashio::log.info "Starting Homely MQTT application..."
exec node dist/index.js